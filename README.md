# EventCalc-SHiP

Sampler of decay events with hypothetical long-lived particles for the SHiP experiment. This is the finalization of Josue Jaramillo's CERN student project [josuejaramillo/summer_school_2024_SHiP](https://github.com/josuejaramillo/summer_school_2024_SHiP).

## Overview

The code
- Takes the tabulated distributions of LLPs in mass, polar angle, and energy (the distribution is averaged over all possible production channels), and the tabulated dependence of the maximum LLP energy on the mass and the polar angle, and samples the 3-momentum of the LLPs in the direction of the decay volume of SHiP.
- Having the generated 4-momenta, samples the decay positions based on the exponential distribution in the LLP decay length.
- Simulates 2-, 3-, or 4-body decays of LLPs using an internal phase space simulator and then passes the events to pythia8 for showering and hadronization of jets. 
- Using the tabulated total yields, decay branching ratios, lifetime-mass dependence, and computed geometric acceptance and decay probability, calculates the total number of decay events.

Currently, the tabulated distributions are generated by [`SensCalc`](https://github.com/maksymovchynnikov/SensCalc). The matrix elements, branching ratios, lifetime dependence on mass, and production fluxes are also taken from it.

Unlike `SensCalc`, the code does not simulate decay products acceptance. Instead, its output is provided to [FairShip](https://github.com/ShipSoft/FairShip) to simulate the propagation and reconstruction of decay products.

## Usage

Running the main file `simulate.py` will first ask users about the number of LLPs sampled in the polar range of the SHiP experiment. Then, users will be asked about: 

 - Selecting the LLP.
 - Typing some LLP parameters such as the mixing pattern, variation of the theoretical uncertainty, and others (optionally, depending on LLP).
 - Selecting the LLP's decay modes for which the simulation will be launched (their names should be self-explanatory).
 - Range of LLP masses for which the simulation will be launched.
 - Range of LLP lifetimes.
 
 After that, the simulation will start. It produces two outputs in the folder `outputs/<LLP>` (see description below):
 - The information about the decay events of LLPs and decay products (the file `eventData/<LLP>_<mass>_<lifetime>_....txt`), with dots meaning the other parameters relevant for the simulation (such as the mixing pattern in the case of HNLs, etc.).
 - The information about total quantities from the simulation: mass, coupling, lifetime, number of events, etc. (the file `eventData/<LLP>/total/<LLP>-...-total.txt`).

## Installation

Ensure you have the required packages installed. You can use the following command to install the dependencies:

```bash
pip3 install numpy sympy numba scipy plotly
```

Also, [pythia8](https://pythia.org/) must be installed with python config. When configuring it, type

`./configure --with-python-config=python3-config`

After `make`, the lib folder has to contain the `pythia8.so` file.

Once this is done, the lib path has to be specified in the script `funcs/decayProducts.py`. Currently, it is

`sys.path.insert(0, '/home/name/Downloads/pythia8312/lib')`



## File Structure

- `funcs/`:
  - `initLLP.py`: Contains the `LLP` class, which initializes the LLP object with attributes like mass, PDGs (Particle Data Group identifiers), and branching ratios.
  - `decayProducts.py`: Contains functions for simulating decays of various LLPs, as well as the routine to perform showering and hadronization of quark and gluon decays via interfacing with `pythia8`.
  - `HNLmerging.py`: Contains functions for handling HNLs with arbitrary mixing pattern given the tabulated distributions, branching ratios, lifetimes, total yields, and decay matrix elements for pure mixings.
  - `PDG.py`: Contains functions or data related to Particle Data Group identifiers.
  - `rotateVectors.py`: Contains functions for rotating vectors.
  - `FourBodyDecay.py`: Contains functions for simulating four-body decays.
  - `ThreeBodyDecay.py`: Contains functions for simulating three-body decays.
  - `TwoBodyDecay.py`: Contains functions for simulating two-body decays.
  - `boost.py`: Contains functions for boosting decay products to the lab frame.
  - `kinematics.py`: Contains functions for handling kinematic distributions and interpolations.
  - `selecting_processing.py`: code to be used by the post-processing scripts.
  - `ship_setup.py`: specifies the SHiP setup used in the simulation and when making plots.

- Main code `simulate.py`: the script to run the decay simulation. 
  
- Post-processing:
  - `events_analysis.py`: the script computing various distributions with the decaying LLP and its decay products: position of the decay vertices, energy distributions, multiplicity, etc. The output is saved in the folder `plots/<LLP>/<LLP>_<mass>_<lifetime>_<other parameters>_decay products`.
  - `total-plots.py`: the script making the plot of some averaged quantities, such as the polar acceptance, total geometric acceptance, mean decay probability, etc., and the plot with the dependence of the number of events as a function of the LLP's coupling and mass. The output is two plots saved in the folder `plots/<LLP>`.
  - `event-display.py`: the script making .pdf and interactive .html plots showing the decay point of the LLP, the direction of its momentum, and the directions of its decay products. The output is the event display of 10 random events for the selected decay mode saved in the folder `plots/<LLP>/eventDisplay/<LLP>_<mass>_<lifetime>_<other parameters>`.

## Output files of the simulation

- The detailed event record file (located in `outputs/<LLP>/eventData/<LLP>_<mass>_<lifetime>_<other parameters>_decayProducts.dat`): 
  - The first string is `Sampled ## events inside SHiP volume. Total number of produced LLPs: ##. Polar acceptance: ##. Azimuthal acceptance: ##. Averaged decay probability: ##. Visible Br Ratio: ##. Total number of events: ##`. The meanings of the numbers are: the total sample size; the total number of LLPs produced during 15 years of SHIP running; the amount of LLPs pointing to the polar range of the experiment; of those, the amount of LLPs that also pass the azimuthal acceptance cut; of those, the averaged probability to decay inside the SHiP volume; the visible branching ratio of selected decay channels; the total number of decay events inside the decay volume.
  - After the first string, the data is split into blocks. Each is started with `#<process=##; sample_points=##>`. The meanings of `##` are: the name of the LLP decay process; the number of samples per this process. After this string, there is the tabulated data with the decay information. The meaning of the elements is as follows: 
 
   `p_x,LLP p_y,LLP p_z,LLP E_LLP mass_LLP PDG_LLP P_decay,LLP x_decay,LLP y_decay,LLP z_decay,LLP p_x,prod1 p_y,prod1 p_z,prod1 E_prod1 mass_prod1 pdg_prod1 p_x,prod2 ...`
 
  - where `...` means the data for the other decay products. The units are GeV (for mass, momentum, and energy) or meters (for coordinates). The center of the coordinate system corresponds to the center of the SHiP target. Some of the rows end with the strings `0. 0. 0. 0. 0. -999.`, to account for varying number of decay products in the same decay channel and maintain the flat array if merging all the datasets.
  
- The file with the total information (located in `outputs/<LLP>/Total`): contains the self-explanatory header describing the meaning of columns. Results of various simulations corresponding to the same LLP setup (such as the choice of the phenomenology within the theoretical uncertainty and the mixing pattern) are added to the corresponding files.


## Implemented LLPs

Currently, the following LLPs are implemented:

- HNLs `N` with arbitrary mixing patterns (`HNL`). Corresponds to the so-called BC6 (if the pattern is 1:0:0), BC7 (if the pattern is 0:1:0), BC8 (0:0:1) models according to the [PBC definition](https://arxiv.org/abs/1901.09966). Of course, the pattern may be made arbitrary.
- Higgs-like scalars `S` that have mass mixing with the Higgs bosons (`Scalar-mixing`). This corresponds to the BC4 model.
- Higgs-like scalars `S` produced by the trilinear coupling (`Scalar-quartic`). The default value of the trilinear coupling is fixed in a way such that `Br(h->SS) = 0.01`, which corresponds to the so-called BC5 model. If one wants to compute the total number of events in the BC5 model, one needs just to sum the event rate from the mixing model and the quartic model for the given scalar mass and lifetime.
- ALPs `a` coupled to photons (`ALP-photon`). Corresponds to the BC9 model.
- Dark photons `V` (`Dark-photons`). They have a large theoretical uncertainty in the production. Because of this, the users are asked to select the flux within the range of this uncertainty - `lower`, `central`, or `upper` (see [2409.11096](https://arxiv.org/abs/2409.11096) for details). Corresponds to the BC1 model. 

### LLP phenomenology description

The phenomenology of various LLPs implemented in `EventCalc` follows the description used in `SensCalc`: 

- [1805.08567](https://arxiv.org/abs/1805.08567) for HNLs. Minor changes include improved matching between exclusive and perturbative QCD descriptions of decays into hadrons (separately for neutral and charged current processes and for three various mixing).
- [1904.10447](https://arxiv.org/abs/1904.10447) for Higgs-like scalars. Minor changes include the modification of the decay width into gluons (higher order QCD corrections are taken into account).
- [1904.02091](https://arxiv.org/abs/1904.02091) for the ALPs coupled to photons.
- [2409.11096](https://arxiv.org/abs/2409.11096) and references therein for the dark photons. 

The phenomenology is very different from the descriptions in the PBC report. This is because the latter is quite outdated. 

## Validation

The code has been intensively cross-checked against `SensCalc` (which, in its turn, has been tested against `FairShip` and other tools), see [slides](https://indico.cern.ch/event/1481729/contributions/6256116/). The agreement in all the quantities is within 10%.

  
## To be done

- Adding more LLPs (ALPs, B-L mediators, HNLs with dipole coupling, inelastic and elastic LDM, etc.).
- Adding theoretical uncertainty (decay widths for Higgs-like scalars, B-L production uncertainties, etc.).
- Improving the performance of the code (parallelization of pythia8 run, etc.).
- Adjusting the SHiP setup with the up-to-date setup if needed.
- Adding cascade production from kaons and light mesons for HNLs, Higgs-like scalars, dark photons.
- Adding more sophisticated simulation codes (such as the machinery to simulate HNL-anti-HNL oscillations).
- Introduce individual identifiers for various LLPs (currently, it is 12345678).
